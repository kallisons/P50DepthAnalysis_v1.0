### P<sub>50</sub> Depth Analysis v1.0
-----------------------------  
Blood-oxygen binding for species living in the pelagic ocean  
* explain P<sub>50</sub> and &Delta;H
* assumes acclimation to temperatures at 10 m depth in the mixed layer.

Please cite the following paper if you use this code:  
Mislan, K. A. S., J. P. Dunne, and J. L. Sarmiento. (in press)  The fundamental niche of blood-oxygen binding in the pelagic ocean. [doi](http://dx.doi.org/10.1111/oik.02650)  


---------------------------
#### Software dependencies
---------------------------
**All the required software is open source.**

NOAA Ferret v6.82:[http://www.ferret.noaa.gov/Ferret/](http://www.ferret.noaa.gov/Ferret/)

Python v2.7.6: [https://www.python.org/](https://www.python.org/)  
Python packages:

R v3.2.2: [http://www.r-project.org/](http://www.r-project.org/)  
R packages:

**Operating system information:**

Mac OS X and Unix-like operating systems should be able to install NOAA Ferret and R without any additional dependencies.

NOAA Ferret running under Windows is not currently supported.  The NOAA Ferret [documentation](http://ferret.pmel.noaa.gov/Ferret/downloads/downloading_ferret) has suggestions for running NOAA Ferret on Windows operating systems.

---------------
#### Folders
---------------
**EnvironmentalData:** This folder contains the oxygen and temperature data used to calculate the P<sub>50</sub>  depth.  

**Graphs:**  This folder is where graphs generated by the Python code and R code will be saved.

**PythonCode:**  This folder contains the Python code that is used to generate the geographic maps of P<sub>50</sub> depth.

**RCode:**  This folder contains the R code that is used to generate plots of the results.

**Results:**  This folder contains the results that will be generated by the shell scripts that run the NOAA Ferret software.

**ShellScripts:**  The shell scripts automate the calculation of P<sub>50</sub> depth for different physiological parameters using the NOAA Ferret software.    

**TestFiles:**  Contains test files to verify the results were generated correctly by the NOAA Ferret software.  

--------------------------
#### Environmental data
--------------------------
The data in NetCDF format was obtained from the [NOAA National Centers for Environmental Information World Ocean Atlas 2009](https://www.nodc.noaa.gov/OC5/WOA09/netcdf_data.html).  The oxygen data were corrected for bias using methods developed by [Bianchi et al. 2012](http://dx.doi.org/10.1029/2011GB004209), and converted from oxygen concentration to oxygen pressure using equations from [Garcia and Gordon (1992)](http://dx.doi.org/10.4319/lo.1992.37.6.1307).

-------------------------------
#### Running the analysis code
-------------------------------
The analysis to calculate P<sub>50</sub> depth is run in NOAA Ferret using shell scripts in the ShellScripts folder. P<sub>50</sub> at 10 m depth and &Delta;H values to be analyzed can be added or changed at the top of the P50Depth_ABC.sh, P50Depth.sh, and P50Depth_geostats.sh files.  The output from the shell scripts will be put in the Results folder.  The commands assume that the current directory is the P50DepthAnalysis_v1.0 folder.  P50Depth.sh produces 1.5 GB of results.  

Commands to run shell scripts:  

    sh ShellScripts/60umolkg_Depth/60umolkg_Depth.sh
    sh ShellScripts/P50/P50.sh
    sh ShellScripts/P50Depth_ABC/P50Depth_ABC.sh
    sh ShellScripts/P50Depth_ABC_Differences/P50Depth_ABC_Differences.sh

Command to run shell script (takes some time to run):

    sh ShellScripts/Geostats_P50Depth/P50Depth_geostats.sh

Command to run shell script (takes some time to run and produces 1.5 GB of results):  

    sh ShellScripts/P50Depth/P50Depth.sh

-----------------------------
#### Verifying the results
-----------------------------
Compare results generated using the commands above to a set of test files to make sure the results are the same. P50Depth.sh produces 1.5 GB of results so a set of test files is not included.  The analysis in P50Depth.sh is the same as the P50Depth_ABC.sh - the difference is that P50Depth.sh produces results for a wider range of P50 and &Delta;H parameters.

Commands to run comparison tests:

    Rscript RCode/RunTest_60umolkg_Depth.R
    Rscript RCode/RunTest_P50.R
    Rscript RCode/RunTest_P50Depth_ABC.R
    Rscript RCode/RunTest_P50Depth_geostats.R


-----------------------------
#### Graphing the results
-----------------------------

Commands to graph the results:

    Rscript RCode/Analysis_P50Depth_point.R
    Rscript RCode/Analysis_P50Depth_transect.R
    python PythonCode/P50Depth_ABC_Maps.py
    python PythonCode/P50Depth_ABC_Differences_Maps.py
    Rscript Analysis_P50Depth_parameters.R

-----------------------------
#### Acknowledgements
-----------------------------

Code Release:  
KAS was supported by the Washington Research Foundation Fund for Innovation in Data-Intensive Discovery and the Moore/Sloan Data Science Environments Project at the University of Washington.

Research:  
This research was supported by the NOAA Cooperative Institute for Climate Science (NA08OAR4320752) and the Carbon Mitigation Initiative at Princeton University which is sponsored by BP.
